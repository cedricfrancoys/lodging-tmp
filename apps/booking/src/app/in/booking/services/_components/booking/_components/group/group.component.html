<!-- template vars -->
<div #vGroup="var" [var]="{identification: {folded: true}, products: {folded: true}, accomodations: {folded: false}, meals: {folded: true}}"></div>

<div [class.hidden]="!ready">

    <div class="group-expand" style="position: absolute;right: 6px;" *ngIf="folded">
        <button mat-icon-button
            (click)="toggleFold()">
            <mat-icon>expand_more</mat-icon>
        </button>
    </div>
    <div class="group-collapse" style="position: absolute;right: 6px;" *ngIf="!folded">
        <button mat-icon-button
            (click)="toggleFold()">
            <mat-icon>expand_less</mat-icon>
        </button>
    </div>

    <!-- one liner : summarized group / sojourn -->
    <!-- #memo - blocks are hidden instead of ngIf-ied to allow dynamic DOM updates -->
    <div [class.hidden]="!folded" class="group-liner" style="height: 35px; padding: 8px 100px 0 15px; cursor: pointer;">
        <div style="display: flex;">
            <!-- group summary (main product) -->
            <div class="group-liner-part" style="width: 25%; margin-right: 18px;">
                <div *ngIf="!groupSummaryOpen" style="white-space: nowrap; overflow: hidden;" (click)="onclickGroupSummary()">
                    {{instance.name}}
                </div>
                <div *ngIf="groupSummaryOpen" style="position: relative;">
                    <sb-m2o-select style="transform: translateY(2px);"
                        class="group-summary-select"
                        [entity]="'lodging\\sale\\catalog\\Product'"
                        [controller]="'lodging_sale_catalog_product_collect'"
                        [params]="{center_id: booking.center_id.id, date_from: instance.date_from.toISOString(), date_to: instance.date_to.toISOString()}"
                        [placeholder]="'Commencez à taper le nom'"
                        [noResult]="'rien trouvé'"
                        [autofocus]="true"
                        (itemSelected)="selectedGroupSummaryProduct($event)"
                        (blur)="onblurGroupSummarySelect()"></sb-m2o-select>
                </div>
            </div>
            <!-- group type -->
            <div class="group-liner-part" style="width: 10%; margin-right: 18px;">
                <div *ngIf="!groupTypeOpen" style="white-space: nowrap; overflow: hidden; " (click)="onclickGroupType()">
                    <span *ngIf="instance.group_type == 'simple'">simple</span>
                    <span *ngIf="instance.group_type == 'sojourn'">séjour</span>
                    <span *ngIf="instance.group_type == 'event'">événement</span>
                    <span *ngIf="instance.group_type == 'camp'">stage</span>
                </div>
                <div *ngIf="groupTypeOpen" style="position: relative;" (click)="onclickGroupType()">
                    <mat-form-field appearance="standard" style="transform: translateY(-31px); padding: 0;">
                        <mat-select [value]="instance.group_type"
                        (closed)="onblurGroupType()"
                        (selectionChange)="onchangeGroupType($event.value)">
                            <mat-option value="simple">simple</mat-option>
                            <mat-option value="event">événement</mat-option>
                            <mat-option value="sojourn">séjour</mat-option>
                            <mat-option value="camp">stage</mat-option>
                        </mat-select>
                    </mat-form-field>
                </div>
            </div>
            <!-- date(s) -->
            <div class="group-liner-part" style="width: 35%; margin-right: 18px;">
                <ng-container *ngIf="instance.group_type == 'event' || instance.group_type == 'sojourn' || instance.group_type == 'camp'">
                    <div *ngIf="!groupDatesOpen" style="white-space: nowrap; overflow: hidden;" (click)="onclickGroupDates()">
                        {{instance.date_from | date: 'dd/MM/YY'}}
                        -
                        {{instance.date_to | date: 'dd/MM/YY'}}&nbsp;
                        <small>
                            <ng-container *ngIf="instance.group_type == 'sojourn' || instance.group_type == 'camp'">({{instance.nb_nights}} nuit<span *ngIf="instance.nb_nights > 1">s</span>)</ng-container>
                            <ng-container *ngIf="instance.group_type == 'event'">({{instance.nb_nights + 1}} jour<span *ngIf="instance.nb_nights+1 > 1">s</span>)</ng-container>
                        </small>
                    </div>
                    <div *ngIf="groupDatesOpen" style="position: relative;">
                        <mat-form-field style="transform: translateY(-18px); padding: 0;">
                            <mat-date-range-input [rangePicker]="sojournDateRangePicker">
                                <input matStartDate [formControl]="vm.daterange.start.formControl">
                                <input matEndDate [formControl]="vm.daterange.end.formControl">
                            </mat-date-range-input>
                            <mat-datepicker-toggle matSuffix [for]="sojournDateRangePicker"></mat-datepicker-toggle>
                            <mat-date-range-picker #sojournDateRangePicker (closed)="onchangeDateRange()"></mat-date-range-picker>
                        </mat-form-field>
                    </div>
                </ng-container>
            </div>
            <!-- nb pers -->
            <div class="group-liner-part" style="width: 15%;">
                <div *ngIf="!groupNbPersOpen" style="white-space: nowrap; overflow: hidden;" (click)="onclickGroupNbPers()">{{instance.nb_pers}} pers.</div>
                <div *ngIf="groupNbPersOpen" style="position: relative;">
                    <mat-form-field style="transform: translateY(-18px); padding: 0;">
                        <input
                            type="number"
                            matInput
                            (blur)="onblurGroupNbPers()"
                            (keyup.enter)="onblurGroupNbPers()"
                            (keyup.esc)="onblurGroupNbPers()"
                            [value]="instance.nb_pers"
                            [formControl]="vm.participants_count.formControl">
                    </mat-form-field>
                </div>
            </div>
            <!-- price -->
            <div class="group-liner-part" style="width: 10%; text-align: right;">
                <div style="margin-left: auto; white-space: nowrap; overflow: hidden;">{{instance.price | number : '1.2-2'}}€</div>
            </div>
        </div>
    </div>

    <!-- expanded pane : all details of group / sojourn -->
    <div [class.hidden]="folded">

        <div class="loader-overlay" *ngIf="loading">
            <div class="loader"><mat-spinner></mat-spinner></div>
        </div>

        <!-- identification-->
        <div class="part">

            <div class="part-toggle">
                <button mat-icon-button *ngIf="!vGroup.identification.folded"
                    (click)="vGroup.identification.folded = !vGroup.identification.folded">
                    <mat-icon style="font-size: 15px;">keyboard_arrow_up</mat-icon>
                </button>
                <button mat-icon-button *ngIf="vGroup.identification.folded"
                    (click)="vGroup.identification.folded = !vGroup.identification.folded">
                    <mat-icon style="font-size: 15px;">keyboard_arrow_right</mat-icon>
                </button>
            </div>

            <div class="part-container" >

                <!-- sojourn details -->
                <div class="row row-identification" style="width: calc(100% - 92px);">

                    <!-- sojourn name -->
                    <div class="cell" style="flex: 2 1 0; max-width: 500px; min-width: 100px;">
                        <mat-form-field class="header">
                            <mat-label>Intitulé</mat-label>
                            <input type="text" matInput (blur)="onchangeName()" [formControl]="vm.name.formControl">
                            <mat-hint>Libellé du regroupement.</mat-hint>
                            <mat-error *ngIf="vm.name.formControl.hasError('required')">
                                Ne peut être vide.
                            </mat-error>
                        </mat-form-field>
                    </div>

                    <div class="cell" style="flex: 0.5 1 0; max-width: 150px; min-width: 50px;">
                        <mat-form-field>
                            <mat-label>Type</mat-label>
                            <mat-select
                                [value]="instance.group_type"
                                (selectionChange)="onchangeGroupType($event.value)">
                                <mat-option value="simple">simple</mat-option>
                                <mat-option value="event">événement</mat-option>
                                <mat-option value="sojourn">séjour</mat-option>
                                <mat-option value="camp">stage</mat-option>
                            </mat-select>
                        </mat-form-field>
                    </div>

                    <!-- participants -->
                    <div class="cell" style="flex: 0.5 1 0; max-width: 155px; min-width: 60px;">
                        <mat-form-field>
                            <mat-label>Participants</mat-label>
                            <input
                                type="number"
                                matInput
                                (blur)="onchangeNbPers()"
                                [value]="instance.nb_pers"
                                [formControl]="vm.participants_count.formControl">
                            <mat-hint>Nombre de personnes</mat-hint>
                            <mat-error *ngIf="vm.participants_count.formControl.hasError('required')">
                                Doit être supérieur à 0.
                            </mat-error>
                        </mat-form-field>
                    </div>

                </div>

                <!-- sojourn specifics -->
                <div class="row row-identification" *ngIf="instance.group_type == 'sojourn' || instance.group_type == 'event' || instance.group_type == 'camp'" >

                    <!-- sojourn dates -->
                    <div class="cell" style="flex: 1.5 1 0; max-width: 260px; min-width: 100px;">
                        <mat-form-field>
                            <mat-label>Dates</mat-label>
                            <mat-date-range-input [rangePicker]="sojournDateRangePicker">
                                <input matStartDate placeholder="dd/mm/yyyy" [formControl]="vm.daterange.start.formControl">
                                <input matEndDate placeholder="dd/mm/yyyy" [formControl]="vm.daterange.end.formControl" (blur)="onchangeDateRange()">
                            </mat-date-range-input>
                            <mat-datepicker-toggle matSuffix [for]="sojournDateRangePicker"></mat-datepicker-toggle>
                            <mat-date-range-picker #sojournDateRangePicker (closed)="onchangeDateRange()"></mat-date-range-picker>
                            <mat-hint [align]="'start'">Du {{getDayOfWeek(instance.date_from)}} au {{getDayOfWeek(instance.date_to)}}</mat-hint>
                            <mat-hint [align]="'end'">
                                <strong>
                                    <ng-container *ngIf="instance.group_type == 'sojourn' || instance.group_type == 'camp'">{{vm.daterange.nights_count}} nuitée{{(vm.daterange.nights_count > 1)?'s':''}}</ng-container>
                                    <ng-container *ngIf="instance.group_type == 'event'">{{vm.daterange.nights_count+1}} jour{{(vm.daterange.nights_count+1 > 1)?'s':''}}</ng-container>
                                </strong>
                            </mat-hint>
                        </mat-form-field>
                    </div>

                    <!-- checkin time -->
                    <div class="cell" style="max-width: 125px;">
                        <mat-form-field>
                            <mat-label>Checkin</mat-label>
                            <mat-select [formControl]="vm.timerange.checkin.formControl">
                                <mat-option value="07:00">07:00</mat-option>
                                <mat-option value="07:30">07:30</mat-option>
                                <mat-option value="08:00">08:00</mat-option>
                                <mat-option value="08:30">08:30</mat-option>
                                <mat-option value="09:00">09:00</mat-option>
                                <mat-option value="09:15">09:15</mat-option>
                                <mat-option value="09:30">09:30</mat-option>
                                <mat-option value="09:45">09:45</mat-option>
                                <mat-option value="10:00">10:00</mat-option>
                                <mat-option value="10:15">10:15</mat-option>
                                <mat-option value="10:30">10:30</mat-option>
                                <mat-option value="11:00">11:00</mat-option>
                                <mat-option value="11:15">11:15</mat-option>
                                <mat-option value="11:30">11:30</mat-option>
                                <mat-option value="11:45">11:45</mat-option>
                                <mat-option value="12:00">12:00</mat-option>
                                <mat-option value="12:15">12:15</mat-option>
                                <mat-option value="12:30">12:30</mat-option>
                                <mat-option value="12:45">12:45</mat-option>
                                <mat-option value="13:00">13:00</mat-option>
                                <mat-option value="13:15">13:15</mat-option>
                                <mat-option value="13:30">13:30</mat-option>
                                <mat-option value="13:45">13:45</mat-option>
                                <mat-option value="14:00">14:00</mat-option>
                                <mat-option value="14:15">14:15</mat-option>
                                <mat-option value="14:30">14:30</mat-option>
                                <mat-option value="14:45">14:45</mat-option>
                                <mat-option value="15:00">15:00</mat-option>
                                <mat-option value="15:15">15:15</mat-option>
                                <mat-option value="15:30">15:30</mat-option>
                                <mat-option value="15:45">15:45</mat-option>
                                <mat-option value="16:00">16:00</mat-option>
                                <mat-option value="16:15">16:15</mat-option>
                                <mat-option value="16:30">16:30</mat-option>
                                <mat-option value="16:45">16:45</mat-option>
                                <mat-option value="17:00">17:00</mat-option>
                                <mat-option value="17:15">17:15</mat-option>
                                <mat-option value="17:30">17:30</mat-option>
                                <mat-option value="17:45">17:45</mat-option>
                                <mat-option value="18:00">18:00</mat-option>
                                <mat-option value="18:15">18:15</mat-option>
                                <mat-option value="18:30">18:30</mat-option>
                                <mat-option value="18:45">18:45</mat-option>
                                <mat-option value="19:00">19:00</mat-option>
                                <mat-option value="19:15">19:15</mat-option>
                                <mat-option value="19:30">19:30</mat-option>
                                <mat-option value="19:45">19:45</mat-option>
                                <mat-option value="20:00">20:00</mat-option>
                                <mat-option value="20:15">20:15</mat-option>
                                <mat-option value="20:30">20:30</mat-option>
                                <mat-option value="20:45">20:45</mat-option>
                                <mat-option value="21:00">21:00</mat-option>
                                <mat-option value="21:15">21:15</mat-option>
                                <mat-option value="21:30">21:30</mat-option>
                                <mat-option value="21:45">21:45</mat-option>
                                <mat-option value="22:00">22:00</mat-option>
                            </mat-select>

                            <mat-hint [align]="'start'" style="opacity: 1">
                                <span>Heure d'arrivée</span>
                            </mat-hint>
                        </mat-form-field>
                    </div>

                    <!-- checkout time -->
                    <div class="cell" style="max-width: 125px;">

                        <mat-form-field>
                            <mat-label>Checkout</mat-label>
                            <mat-select [formControl]="vm.timerange.checkout.formControl">
                                <mat-option value="07:00">07:00</mat-option>
                                <mat-option value="07:30">07:30</mat-option>
                                <mat-option value="08:00">08:00</mat-option>
                                <mat-option value="08:30">08:30</mat-option>
                                <mat-option value="09:00">09:00</mat-option>
                                <mat-option value="09:30">09:30</mat-option>
                                <mat-option value="10:00">10:00</mat-option>
                                <mat-option value="10:30">10:30</mat-option>
                                <mat-option value="11:00">11:00</mat-option>
                                <mat-option value="11:30">11:30</mat-option>
                                <mat-option value="12:00">12:00</mat-option>
                                <mat-option value="12:30">12:30</mat-option>
                                <mat-option value="13:00">13:00</mat-option>
                                <mat-option value="13:30">13:30</mat-option>
                                <mat-option value="14:00">14:00</mat-option>
                                <mat-option value="14:30">14:30</mat-option>
                                <mat-option value="15:00">15:00</mat-option>
                                <mat-option value="15:30">15:30</mat-option>
                                <mat-option value="16:00">16:00</mat-option>
                                <mat-option value="16:30">16:30</mat-option>
                                <mat-option value="17:00">17:00</mat-option>
                                <mat-option value="17:30">17:30</mat-option>
                                <mat-option value="18:00">18:00</mat-option>
                                <mat-option value="18:30">18:30</mat-option>
                                <mat-option value="19:00">19:00</mat-option>
                                <mat-option value="19:30">19:30</mat-option>
                                <mat-option value="20:00">20:00</mat-option>
                                <mat-option value="20:30">20:30</mat-option>
                                <mat-option value="21:00">21:00</mat-option>
                                <mat-option value="21:30">19:30</mat-option>
                                <mat-option value="22:00">20:00</mat-option>
                                <mat-option value="22:30">20:30</mat-option>
                                <mat-option value="23:00">23:00</mat-option>
                            </mat-select>

                            <mat-hint [align]="'start'" style="opacity: 1">
                                <span>Heure de départ</span>
                            </mat-hint>
                        </mat-form-field>
                    </div>

                </div>

                <!-- additional (optional) details about the group (can be folded) -->
                <div class="row row-identification" [class.hidden]="vGroup.identification.folded">
                    <!-- fare class / rateClass -->
                    <div class="cell" style="max-width: 350px;">
                        <mat-form-field>
                            <mat-label>Catégorie tarifaire</mat-label>
                            <input matInput type="text" [matAutocomplete]="rateClassAutocomplete"
                                [value]="calcRateClass()" (keyup)="vm.rate_class.inputChange($event)"
                                (focus)="vm.rate_class.focus()" (blur)="vm.rate_class.restore()"
                                placeholder="Commencez à taper le nom" />

                            <button mat-button *ngIf="vm.rate_class.name?.length" matSuffix mat-icon-button
                                aria-label="Clear" (click)="vm.rate_class.reset()">
                                <mat-icon>close</mat-icon>
                            </button>

                            <mat-autocomplete #rateClassAutocomplete="matAutocomplete"
                                [displayWith]="vm.rate_class.display" (optionSelected)="onchangeRateClass($event)">
                                <div *ngIf="vm.rate_class.filteredList | async; let list">
                                    <mat-option *ngFor="let rate_class of list" [value]="rate_class">
                                        {{rate_class.name}} - {{rate_class.description}}
                                    </mat-option>
                                    <mat-option *ngIf="list.length == 0"><i>pas de résultat</i></mat-option>
                                </div>
                            </mat-autocomplete>

                            <mat-hint [align]="'start'" style="opacity: 1">
                                <span>Classe de tarifs à appliquer</span>
                            </mat-hint>
                        </mat-form-field>
                    </div>

                    <!-- sojourn type -->
                    <div *ngIf="instance.is_sojourn" class="cell" style="flex: 0.5 1 0; max-width: 120px; min-width: 60px;">
                        <mat-form-field>
                            <mat-label>Type de séjour</mat-label>
                            <mat-select [ngModel]="vm.sojourn_type.value"
                                (selectionChange)="onchangeSojournType($event)">
                                <mat-option value="GG">GG</mat-option>
                                <mat-option value="GA">GA</mat-option>
                            </mat-select>
                        </mat-form-field>
                    </div>
                </div>
                <!-- participants ages details (can be folded)-->
                <div class="row" [class.hidden]="vGroup.identification.folded">
                    <div>
                        <div style="padding-left: 12px;">
                            Âges des participants
                            <button mat-mini-fab
                                color="primary"
                                style="transform: scale(0.66);"
                                (click)="oncreateAgeRange();"
                                title="Ajouter une tranche d'âge">
                                <mat-icon>add</mat-icon>
                            </button>
                        </div>
                        <div style="padding-left: 12px;">
                            <div *ngFor="let agerange of instance.age_range_assignments_ids; let index = index;" style="display: flex;">
                                <booking-services-booking-group-agerangeassignment
                                    [model]="agerange"
                                    [group]="instance"
                                    [booking]="booking"
                                    (updating)="onupdatingAgeRange($event)"
                                    (updated)="onupdateAgeRange()"
                                ></booking-services-booking-group-agerangeassignment>

                                <div class="product-remove">
                                    <button mat-icon-button
                                        (click)="ondeleteAgeRange(agerange.id)">
                                        <mat-icon>delete</mat-icon>
                                    </button>
                                </div>

                            </div>
                        </div>
                    </div>
                </div>

            </div>

        </div>

        <!-- products -->
        <div class="part">
            <div class="part-toggle">
                <button mat-icon-button *ngIf="!vGroup.products.folded" (click)="vGroup.products.folded = true">
                    <mat-icon style="font-size: 15px;">keyboard_arrow_up</mat-icon>
                </button>
                <button mat-icon-button *ngIf="vGroup.products.folded" (click)="vGroup.products.folded = false">
                    <mat-icon style="font-size: 15px;">keyboard_arrow_right</mat-icon>
                </button>
            </div>

            <div class="part-container">
                <div class="row">
                    <div class="row-products-title">
                            <span>Produits ({{instance.booking_lines_ids.length}})</span>
                            <button *ngIf="!vm.pack.is_locked" mat-mini-fab
                                    color="primary"
                                    style="transform: scale(0.66);"
                                    (click)="vGroup.products.folded = false; oncreateLine()"><mat-icon>add</mat-icon>
                            </button>
                            <span *ngIf="instance.is_extra && instance.has_schedulable_services && !instance.has_consumptions"
                                style="margin-left: 20px; color: var(--mdc-theme-error, #b00020);">Services planifiables présents
                            </span>
                            <button *ngIf="instance.is_extra && instance.has_schedulable_services && !instance.has_consumptions"
                                mat-button
                                color="primary"
                                (click)="onclickCreateConsumptions()">CRÉER LES CONSOMMATIONS
                            </button>
                    </div>
                    <div class="row-products-price" [class.hidden]="!vGroup.products.folded">TOTAL TTC &nbsp;:&nbsp; {{instance.price | currency : 'EUR' : 'symbol' : '1.2-2' : 'fr-FR'}} <br />AVANTAGE ({{instance.fare_benefit/(instance.price+instance.fare_benefit) | percent}})&nbsp;:&nbsp; {{instance.fare_benefit | currency : 'EUR' : 'symbol' : '1.2-2' : 'fr-FR'}}</div>
                </div>
                <div class="row" [class.hidden]="vGroup.products.folded">
                    <!-- pack selector -->
                    <div class="row" >

                        <!-- has pack -->
                        <div class="cell" style="max-width: 200px;">
                            <mat-form-field floatLabel="always" class="invisible-label">
                                <mat-slide-toggle
                                    color="primary"
                                    [ngModel]="instance.has_pack"
                                    (change)="onchangeHasPack($event.checked)">Utiliser un pack</mat-slide-toggle>
                                <textarea matInput hidden></textarea>
                            </mat-form-field>
                        </div>

                        <!-- ref pack-->
                        <div class="cell" style="flex: 1 1 500px; max-width: 500px;" *ngIf="instance.has_pack">
                            <mat-form-field>
                                <mat-label>Référence du Pack</mat-label>
                                <input
                                    *ngIf="!vm.pack.name.length"
                                    matInput
                                    type="text"
                                    [matAutocomplete]="packAutocomplete"
                                    [value]="vm.pack.name"
                                    (keyup)="vm.pack.inputChange($event)"
                                    (focus)="vm.pack.focus()"
                                    (blur)="vm.pack.restore()"
                                    placeholder="Commencez à taper le nom" />
                                <input
                                    *ngIf="vm.pack.name.length"
                                    matInput
                                    type="text"
                                    [value]="vm.pack.name"
                                    readonly />
                                <!-- #memo - this leads to inconsistent pack with products and age-ranges non-related to the re-selected pack_id (product)
                                <button mat-button *ngIf="vm.pack.name.length" matSuffix mat-icon-button aria-label="Clear" (click)="vm.pack.reset()">
                                    <mat-icon>close</mat-icon>
                                </button>
                                -->

                                <mat-autocomplete
                                    #packAutocomplete="matAutocomplete"
                                    [displayWith]="calcPack"
                                    (optionSelected)="onchangePackId($event.option.value)">
                                    <div *ngIf="vm.pack.filteredList | async; let list">
                                        <mat-option *ngFor="let pack of list" [value]="pack">
                                            <span title="{{pack.sku}}">{{pack.name}}</span>
                                        </mat-option>
                                        <mat-option *ngIf="list.length == 0"><i>pas de résultat</i></mat-option>
                                    </div>
                                </mat-autocomplete>

                                <mat-hint [align]="'start'" style="opacity: 1">
                                    <span>Pack de produits utilisé pour le groupe de services</span>
                                </mat-hint>
                            </mat-form-field>
                        </div>

                        <!-- locked pack -->
                        <div class="cell" *ngIf="instance.has_pack">
                            <mat-form-field floatLabel="always" class="invisible-label">
                                <mat-slide-toggle
                                    [ngModel]="vm.pack.is_locked"
                                    [disabled]="true"
                                    (change)="onchangeIsLocked($event.checked)"
                                    title="Liste des produits du pack non-modifiable">Liste verrouillée
                                </mat-slide-toggle>
                                <textarea matInput hidden></textarea>
                            </mat-form-field>
                        </div>

                    </div>
                    <div class="row-products-price">TOTAL TTC &nbsp;:&nbsp; {{instance.price | currency : 'EUR' : 'symbol' : '1.2-2' : 'fr-FR'}} <br />AVANTAGE ({{instance.fare_benefit/(instance.price+instance.fare_benefit) | percent}})&nbsp;:&nbsp; {{instance.fare_benefit | currency : 'EUR' : 'symbol' : '1.2-2' : 'fr-FR'}}</div>
                </div>

                <div class="row" [class.hidden]="vGroup.products.folded">
                    <div style="width: 100%;">
                        <div class="products-header">
                            <div style="display: flex; width: 100%; margin-bottom: 6px; padding-left: 1px;">
                                <div class="product-cell" style="text-align: left;">SKU</div>
                                <div class="product-cell">QTÉ</div>
                                <div class="product-cell">GTÉ</div>
                                <div class="product-cell">P.U.</div>
                                <div class="product-cell">RÉDUC</div>
                                <div class="product-cell">TVA</div>
                                <div class="product-cell">PRIX</div>
                                <!-- actions -->
                                <div class="product-cell" style="max-width: 35px;"></div>
                            </div>
                        </div>

                        <div class="products-list" cdkDropList (cdkDropListDropped)="vm.lines.drop($event)">
                            <!-- products -->
                            <div class="product-item" cdkDrag [cdkDragData]="line" *ngFor="let line of instance.booking_lines_ids; let index = index;">
                                <div class="product-handle" cdkDragHandle>
                                    <mat-icon style="font-size: 16px;">drag_indicator</mat-icon>
                                </div>
                                <div class="product-remove">
                                    <button *ngIf="!vm.pack.is_locked" mat-icon-button
                                        (click)="ondeleteLine(line.id)">
                                        <mat-icon>delete</mat-icon>
                                    </button>
                                </div>
                                <booking-services-booking-group-line
                                    [model]="line"
                                    [group]="instance"
                                    [booking]="booking"
                                    (updated)="onupdateLine()"
                                ></booking-services-booking-group-line>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

        </div>


        <!-- accommodations -->
        <div class="part">

            <div class="part-toggle" style="padding-top: 20px;">
                <button mat-icon-button *ngIf="!vGroup.accomodations.folded" (click)="vGroup.accomodations.folded = !vGroup.accomodations.folded">
                    <mat-icon style="font-size: 15px;">keyboard_arrow_up</mat-icon>
                </button>
                <button mat-icon-button *ngIf="vGroup.accomodations.folded" (click)="vGroup.accomodations.folded = !vGroup.accomodations.folded">
                    <mat-icon style="font-size: 15px;">keyboard_arrow_right</mat-icon>
                </button>
            </div>

            <div class="part-container" *ngIf="vGroup.accomodations.folded">
                <div class="row" style="align-items: center;">
                    <div style="height: 72px; line-height: 72px;">Unités locatives </div>
                </div>
            </div>

            <div class="part-container" *ngIf="!vGroup.accomodations.folded">
                <div class="row" style="align-items: center;">
                    <div style="flex: 0 1 200px; height: 62px; line-height: 62px;">Unités locatives </div>
                    <mat-form-field
                        *ngIf="!user?.center_office?.rentalunits_manual_assignment || instance.has_locked_rental_units"
                        style="flex: 0 1 400px;"
                        floatLabel="always"
                        class="invisible-label">
                        <mat-slide-toggle color="accent"
                                          [checked]="instance.has_locked_rental_units"
                                          (change)="onchangeHasLockedRentalUnits($event)">Verrouiller la répartition des unités locatives
                        </mat-slide-toggle>
                        <textarea matInput hidden></textarea>
                    </mat-form-field>
                </div>
                <div class="row" style="display: block;">
                    <div class="accomodation-item" *ngFor="let accomodation of instance.sojourn_product_models_ids; let index = index;">
                        <booking-services-booking-group-rentalunitassignment
                            [model]="accomodation"
                            [group]="instance"
                            [booking]="booking"
                            [mode]="mode"
                            (updated)="onupdateAccomodation()"
                        ></booking-services-booking-group-rentalunitassignment>
                    </div>
                </div>
            </div>
        </div>

        <!-- meals preferences (for hostels only / 'GA')-->
        <div class="part" *ngIf="(instance.is_sojourn && instance.sojourn_type_id == 1) || instance.group_type == 'event'">

            <div class="part-toggle" style="padding-top: 12px;">
                <button mat-icon-button *ngIf="!vGroup.meals.folded" (click)="vGroup.meals.folded = true">
                    <mat-icon style="font-size: 15px;">keyboard_arrow_up</mat-icon>
                </button>
                <button mat-icon-button *ngIf="vGroup.meals.folded" (click)="vGroup.meals.folded = false">
                    <mat-icon style="font-size: 15px;">keyboard_arrow_right</mat-icon>
                </button>
            </div>

            <div class="part-container">
                <div class="row">
                    <div style="margin-top: 8px;">
                            <span>Restrictions et Préférences repas ({{instance.meal_preferences_ids.length}})</span>
                            <button mat-mini-fab
                                    color="primary"
                                    style="transform: scale(0.66);"
                                    (click)="vGroup.meals.folded = false; oncreateMealPref()">
                                <mat-icon>add</mat-icon>
                        </button>
                    </div>
                </div>
                <div class="row" *ngIf="!vGroup.meals.folded" style="display: block;">
                    <div *ngFor="let preference of instance.meal_preferences_ids; let index = index;" style="display: flex;">
                        <div class="mealpref-item">
                            <booking-services-booking-group-mealpref
                                [model]="preference"
                                [group]="instance"
                                [booking]="booking"
                                (updated)="onupdateMealPref()"
                            ></booking-services-booking-group-mealpref>
                        </div>
                        <div class="row-remove"><button mat-icon-button (click)="ondeleteMealPref(preference.id)"> <mat-icon>delete</mat-icon></button></div>
                    </div>
                </div>
            </div>
        </div>

    </div>

</div>
